<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>CrazyTeacher | Aula Virtual</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6fa0e0;
            --primary-dark: #5a8ac6;
            --bg-start: #eef7ff;
            --bg-end: #9bc5ff;
            --text-main: #475569;
            --text-light: #94a3b8;
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.8);
            --shadow-card: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --shadow-input: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
            --chat-width: 350px;
        }

        * { box-sizing: border-box; }

        body, html { 
            width: 100%; height: 100%; margin: 0; padding: 0; 
            overflow: hidden; 
            background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
            font-family: 'Inter', sans-serif;
            color: var(--text-main);
        }
        
        #unity-container { position: fixed; width: 100%; height: 100%; top: 0; left: 0; z-index: 0; pointer-events: none; }
        #unity-canvas { display: block; width: 100% !important; height: 100% !important; }

        #overlay-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; pointer-events: none; }
        #chatbot-toggle-btn, #chat-widget, #mic-btn { pointer-events: auto !important; }

        /* --- ESTILOS DE SUBT√çTULOS --- */
        #subtitle-overlay {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            text-align: center;
            pointer-events: none;
            z-index: 1500;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            min-height: 4rem; 
        }

        .subtitle-text {
            font-size: 1.8rem;
            font-weight: 700;
            line-height: 1.2;
            font-family: 'Inter', sans-serif;
            transition: opacity 0.2s ease;
            text-shadow: 
                2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000,
                0px 4px 10px rgba(0,0,0,0.6);
        }

        .subtitle-user { color: #6fa0e0; }
        .subtitle-bot { color: white; }

        .float-btn {
            position: fixed; bottom: 30px; height: 65px; width: 65px; 
            border-radius: 50px; border: none;
            background: linear-gradient(to bottom, #7fabda, var(--primary));
            color: white; box-shadow: 0 4px 15px rgba(50, 50, 93, 0.3);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 1002; padding: 0; overflow: hidden;
        }
        
        #chatbot-toggle-btn { right: 30px; z-index: 1001; }
        #chatbot-toggle-btn:hover { transform: scale(1.1) rotate(-10deg); }

        #mic-btn { right: 110px; justify-content: flex-start; }
        #mic-btn.mic-shifted { right: calc(30px + var(--chat-width) + 15px); }

        #mic-btn .icon-container {
            width: 65px; height: 65px; display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; font-size: 1.5rem;
        }
        #mic-btn .text-label {
            white-space: nowrap; opacity: 0; max-width: 0;
            transition: all 0.4s ease; font-weight: 500; font-size: 1rem; padding-right: 0;
        }

        #mic-btn.is-listening {
            width: 190px; 
            background: linear-gradient(to bottom, #3ce057, #48a72b);
            box-shadow: 0 4px 20px rgba(77, 255, 101, 0.4);
        }
        
        #mic-btn.is-bot-speaking {
            width: 190px; background: linear-gradient(to bottom, #a3c9ff, #6fa0e0);
            cursor: wait;
        }

        #mic-btn.is-listening .text-label, 
        #mic-btn.is-bot-speaking .text-label { opacity: 1; max-width: 120px; padding-right: 20px; }
        
        #mic-btn.is-listening .icon-container { animation: mic-pulse 1.5s infinite; }
        @keyframes mic-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .glass-card {
            background: var(--glass-bg); backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border); border-radius: 24px; box-shadow: var(--shadow-card);
            display: flex; flex-direction: column; overflow: hidden;
            position: fixed; bottom: 30px; right: 30px; 
            width: var(--chat-width); height: 500px; max-height: 80vh; z-index: 1000;
        }

        .chat-header { padding: 15px 20px; background: rgba(255,255,255,0.4); display: flex; justify-content: space-between; align-items: center; }
        .chat-body { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .chat-footer { padding: 15px; background: rgba(255,255,255,0.3); }

        .message { display: flex; gap: 10px; max-width: 85%; }
        .message.bot { align-self: flex-start; }
        .message.user { align-self: flex-end; flex-direction: row-reverse; }
        .message-content { padding: 12px 16px; border-radius: 20px; font-size: 0.95rem; background: white; white-space: pre-wrap; }
        .message.user .message-content { background: var(--primary); color: white; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: white; }

        .input-pill { width: 100%; border-radius: 50px; border: none; padding: 10px 20px; outline: none; resize: none; }
        .btn-send { width: 45px; height: 45px; border-radius: 50%; border: none; background: var(--primary); color: white; flex-shrink: 0; display: flex; align-items: center; justify-content: center;}

        @media (max-width: 500px) {
            :root { --chat-width: 90%; }
            #chat-widget { right: 5%; width: 90%; bottom: 10px; height: 60vh; }
            #mic-btn.mic-shifted { right: 20px; bottom: 60vh; margin-bottom: 30px; }
            .subtitle-text { font-size: 1.4rem; }
        }

        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-start); display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 2000;
        }
        .spinner-custom {
            width: 50px; height: 50px; border: 5px solid rgba(111, 160, 224, 0.2);
            border-top: 5px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>

<body>
    <div id="loading-overlay">
        <div class="spinner-custom"></div>
        <div style="color: #475569; font-weight: 600; font-size: 1.1rem; z-index: 10;">Cargando...</div>
    </div>

    <div id="subtitle-overlay">
        <span id="subtitle-text" class="subtitle-text"></span>
    </div>

    <div id="unity-container"><canvas id="unity-canvas" tabindex="-1"></canvas></div>

    <div id="overlay-container">
        <button id="mic-btn" class="float-btn" onclick="handleMicClick()">
            <div class="icon-container"><i class="bi bi-mic-fill" id="mic-icon"></i></div>
            <span class="text-label" id="mic-label">Escuchando...</span>
        </button>

        <button id="chatbot-toggle-btn" class="float-btn" onclick="toggleChat()">
            <i class="bi bi-chat-dots-fill fs-4"></i>
        </button>

        <div id="chat-widget" class="glass-card" style="display: none;">
            <div class="chat-header">
                <div class="d-flex gap-2 align-items-center">
                    <div class="avatar">üëì</div>
                    <div>
                        <div class="fw-bold text-dark">Crazy</div>
                        <div style="font-size: 0.75rem; color: var(--text-light);">Siempre atento</div>
                    </div>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <div class="status-badge">
                        <span id="statusDot" class="status-dot"></span>
                        <span id="connectionStatus">Conectando</span>
                    </div>
                    <button class="btn btn-sm text-secondary" onclick="toggleChat()"><i class="bi bi-x-lg"></i></button>
                </div>
            </div>
            <div class="chat-body" id="chatContainer">
                <div class="message bot">
                    <div class="avatar"><i class="bi bi-robot"></i></div>
                    <div class="message-content"><p class="mb-0">¬°Hola! Soy Pablo. ¬øHablamos?</p></div>
                </div>
            </div>
            <div class="chat-footer">
                <form id="chatForm" class="d-flex gap-2 align-items-center">
                    <textarea class="input-pill" id="userInput" rows="1" placeholder="Escribe aqu√≠..." ></textarea>
                    <button type="submit" class="btn-send" id="sendBtn"><i class="bi bi-send-fill"></i></button>
                </form>
                <div class="d-flex justify-content-between align-items-center mt-2 px-2">
                    <div class="form-check form-switch" style="transform: scale(0.9); transform-origin: left;">
                        <input class="form-check-input" type="checkbox" id="streamToggle" checked>
                        <label class="form-check-label small text-muted" for="streamToggle">Respuesta r√°pida (Stream)</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
      var canvas = document.querySelector("#unity-canvas");
      var config = {
        dataUrl: "BuildVanilla/Build/BuildVanilla.data.unityweb",
        frameworkUrl: "BuildVanilla/Build/BuildVanilla.framework.js.unityweb",
        codeUrl: "BuildVanilla/Build/BuildVanilla.wasm.unityweb",
        streamingAssetsUrl: "BuildVanilla/StreamingAssets",
        companyName: "DefaultCompany",
        productName: "TutorVirtual",
        productVersion: "0.1.0",
      };
      
      var script = document.createElement("script");
      script.src = "BuildVanilla/Build/BuildVanilla.loader.js";
      script.onload = () => {
        createUnityInstance(canvas, config).then((unityInstance) => {
          window.unityInstance = unityInstance; 
          document.getElementById('loading-overlay').style.display = 'none';
          document.getElementById('statusDot').classList.add('online');
          document.getElementById('connectionStatus').innerText = "En l√≠nea";
        }).catch((message) => { alert(message); });
      };
      script.onerror = () => { document.getElementById('loading-overlay').style.display = 'none'; }
      document.body.appendChild(script);
    </script>

    <script>
        const API_URL = 'http://192.168.18.6:8000'; 

        const chatWidget = document.getElementById('chat-widget');
        const toggleBtn = document.getElementById('chatbot-toggle-btn');
        const userInput = document.getElementById('userInput');
        const chatContainer = document.getElementById('chatContainer');
        const micBtn = document.getElementById('mic-btn');
        const micIcon = document.getElementById('mic-icon');
        const micLabel = document.getElementById('mic-label');
        const streamToggle = document.getElementById('streamToggle');
        const sendBtn = document.getElementById('sendBtn');
        const subtitleText = document.getElementById('subtitle-text');

        let isChatOpen = false;
        let isConversationMode = false; 
        let recognition = null;
        let botIsSpeaking = false; 
        let isProcessing = false;

        // --- GESTI√ìN DE SUBT√çTULOS BOT ---
        let botWordQueue = []; 
        let isShowingSubtitle = false;
        let streamBuffer = ""; // Buffer para no cortar palabras
        const TIME_PER_WORD_MS = 320; 
        const MIN_TIME_ON_SCREEN_MS = 1500;

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'es-ES';
            recognition.continuous = false;
            recognition.interimResults = true;

            recognition.onstart = () => {
                updateMicVisuals(true, "Escuchando...");
                clearBotSubtitles();
            };

            recognition.onend = () => {
                if (isConversationMode && !botIsSpeaking) {
                    updateMicVisuals(false, "Pausado");
                }
                if (!isProcessing && !botIsSpeaking) {
                     setTimeout(() => { if(!botIsSpeaking) subtitleText.innerText = ""; }, 2000);
                }
            };

            recognition.onresult = (event) => {
                let transcript = '';
                let interimTranscript = '';
                let isFinal = false;

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    const t = event.results[i][0].transcript;
                    transcript += t;
                    interimTranscript += t;
                    if (event.results[i].isFinal) isFinal = true;
                }

                updateUserSubtitle(interimTranscript);

                if (isChatOpen) {
                    userInput.value = transcript;
                    autoResizeInput();
                }

                if (isFinal && transcript.trim() !== "") {
                    setTimeout(() => { if(!botIsSpeaking) subtitleText.innerText = ""; }, 500);
                    if (isChatOpen) {
                        handleSendMessage(transcript);
                    } else {
                        handleConversationTurn(transcript);
                    }
                }
            };
        }

        function updateUserSubtitle(text) {
            if (!text) return;
            subtitleText.className = "subtitle-text subtitle-user";
            const words = text.trim().split(/\s+/);
            const lastWords = words.length > 7 ? words.slice(-7) : words;
            subtitleText.innerText = lastWords.join(" ");
        }

        function queueBotWords(chunkText) {
            if (!chunkText) return;
            
            // Unimos al buffer lo que llega
            streamBuffer += chunkText;
            
            // Buscamos el √∫ltimo espacio para saber hasta d√≥nde hay palabras completas
            const lastSpaceIndex = streamBuffer.lastIndexOf(" ");
            
            if (lastSpaceIndex !== -1) {
                // Sacamos las palabras completas del buffer
                const completeWordsPart = streamBuffer.substring(0, lastSpaceIndex);
                streamBuffer = streamBuffer.substring(lastSpaceIndex); // Dejamos el resto (posible palabra a medias)
                
                const words = completeWordsPart.split(/\s+/).filter(w => w.length > 0);
                botWordQueue.push(...words);
            }

            processBotSubtitleQueue();
        }

        // Caso especial para cuando el stream termina: vaciamos lo que quede en el buffer
        function flushStreamBuffer() {
            if (streamBuffer.trim().length > 0) {
                const words = streamBuffer.trim().split(/\s+/).filter(w => w.length > 0);
                botWordQueue.push(...words);
                streamBuffer = "";
            }
            processBotSubtitleQueue();
        }

        function processBotSubtitleQueue() {
            if (isShowingSubtitle || botWordQueue.length === 0) return;

            isShowingSubtitle = true;
            const chunk = botWordQueue.splice(0, 7); 
            const textToShow = chunk.join(" ");

            subtitleText.className = "subtitle-text subtitle-bot";
            subtitleText.innerText = textToShow;

            const duration = Math.max(MIN_TIME_ON_SCREEN_MS, chunk.length * TIME_PER_WORD_MS);

            setTimeout(() => {
                if (botWordQueue.length === 0) {
                    subtitleText.innerText = "";
                    isShowingSubtitle = false;
                } else {
                    isShowingSubtitle = false;
                    processBotSubtitleQueue();
                }
            }, duration);
        }

        function clearBotSubtitles() {
            botWordQueue = [];
            isShowingSubtitle = false;
            streamBuffer = "";
            subtitleText.innerText = "";
        }

        window.handleMicClick = function() {
            if (!recognition) return alert("Navegador no compatible");
            if (isChatOpen) {
                if (micBtn.classList.contains('is-listening')) recognition.stop();
                else recognition.start();
            } else {
                if (isConversationMode) stopConversationMode();
                else startConversationMode();
            }
        }

        function startConversationMode() {
            isConversationMode = true;
            try { recognition.start(); } catch(e){}
        }

        function stopConversationMode() {
            isConversationMode = false;
            botIsSpeaking = false;
            clearBotSubtitles();
            try { recognition.stop(); } catch(e){}
            updateMicVisuals(false, "Escuchando...");
        }

        function updateMicVisuals(listening, text) {
            micLabel.innerText = text;
            if (listening) {
                micBtn.classList.add('is-listening');
                micBtn.classList.remove('is-bot-speaking');
                micIcon.className = "bi bi-mic-fill";
            } else {
                micBtn.classList.remove('is-listening');
                if (botIsSpeaking && isConversationMode) {
                    micBtn.classList.add('is-bot-speaking');
                    micIcon.className = "bi bi-volume-up-fill";
                    micLabel.innerText = "Hablando...";
                } else {
                    micBtn.classList.remove('is-bot-speaking');
                    micIcon.className = "bi bi-mic-fill";
                }
            }
        }

        async function handleSendMessage(text) {
            if (!text || isProcessing) return;
            isProcessing = true;
            userInput.value = '';
            autoResizeInput();
            sendBtn.disabled = true;

            clearBotSubtitles();
            addMessage(text, 'user');
            const typingId = showTyping();
            if(window.unityInstance) window.unityInstance.SendMessage('Tutor', 'SetTalkingState', 1);

            let fullLogText = ""; 
            try {
                await processBackendResponse(text, (chunk) => {
                    fullLogText += chunk;
                    const cleanTextFull = fullLogText.length > 16 ? fullLogText.slice(16).trimStart() : "";
                    updateBotMessage(typingId, cleanTextFull);
                });
            } catch (error) {
                removeTyping(typingId);
                addMessage("Error: " + error.message, 'bot');
            } finally {
                isProcessing = false;
                sendBtn.disabled = false;
                flushStreamBuffer(); // Aseguramos que salga la √∫ltima palabra
                const checkFinishInterval = setInterval(() => {
                    if (botWordQueue.length === 0 && !isShowingSubtitle) {
                        if(window.unityInstance) window.unityInstance.SendMessage('Tutor', 'SetTalkingState', 0);
                        clearInterval(checkFinishInterval);
                    }
                }, 500);
            }
        }

        async function handleConversationTurn(text) {
            botIsSpeaking = true; 
            try { recognition.stop(); } catch(e){}
            updateMicVisuals(false, "Pensando...");

            clearBotSubtitles();
            addMessage(text, 'user');
            const typingId = showTyping();
            if(window.unityInstance) window.unityInstance.SendMessage('Tutor', 'SetTalkingState', 1);

            let fullLogText = ""; 
            try {
                await processBackendResponse(text, (chunk) => {
                    fullLogText += chunk;
                    const cleanText = fullLogText.length > 16 ? fullLogText.slice(16).trimStart() : "";
                    updateBotMessage(typingId, cleanText);
                });
            } catch (error) {
                console.error(error);
                removeTyping(typingId);
            }

            updateMicVisuals(false, "Hablando...");
            flushStreamBuffer();

            const checkFinishInterval = setInterval(() => {
                if (botWordQueue.length === 0 && !isShowingSubtitle) {
                    if(window.unityInstance) window.unityInstance.SendMessage('Tutor', 'SetTalkingState', 0);
                    clearInterval(checkFinishInterval);
                    subtitleText.innerText = ""; 

                    if (isConversationMode) {
                        botIsSpeaking = false;
                        try { recognition.start(); } catch(e) {}
                    } else {
                        botIsSpeaking = false;
                        updateMicVisuals(false, "Escuchando...");
                    }
                }
            }, 500);
        }

        async function processBackendResponse(text, onChunkReceived) {
            const isStream = streamToggle && streamToggle.checked;
            const endpoint = isStream ? '/ask/stream' : '/ask';
            
            const response = await fetch(`${API_URL}${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ texto: text, usuario_id: 2 })
            });

            if (!response.ok) throw new Error("Error del servidor: " + response.status);

            let totalReceivedLength = 0;

            if (isStream) {
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    
                    let validChunk = chunk;
                    if (totalReceivedLength < 16) {
                        const remainingCut = 16 - totalReceivedLength;
                        if (chunk.length > remainingCut) validChunk = chunk.slice(remainingCut);
                        else validChunk = ""; 
                    }
                    totalReceivedLength += chunk.length;

                    if (validChunk) queueBotWords(validChunk);
                    onChunkReceived(chunk);
                }
            } else {
                const data = await response.json();
                const result = data.respuesta || data.mensaje || JSON.stringify(data);
                if (result.length > 16) queueBotWords(result.slice(16));
                onChunkReceived(result);
            }
        }

        function addMessage(text, role) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.innerHTML = `<div class="avatar">${role==='bot'?'ü§ñ':'üë§'}</div><div class="message-content"></div>`;
            const content = div.querySelector('.message-content');
            content.innerHTML = typeof marked !== 'undefined' ? marked.parse(text) : text;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function showTyping() {
            const id = `msg-${Date.now()}`;
            const div = document.createElement('div');
            div.className = 'message bot';
            div.id = id;
            div.innerHTML = `<div class="avatar">ü§ñ</div><div class="message-content">...</div>`;
            chatContainer.appendChild(div);
            scrollToBottom();
            return id;
        }

        function updateBotMessage(id, cleanText) {
            const el = document.getElementById(id);
            if (!el) return;
            const content = el.querySelector('.message-content');
            content.innerText = cleanText; 
            scrollToBottom();
        }

        function removeTyping(id) { document.getElementById(id)?.remove(); }
        function scrollToBottom() { setTimeout(() => { chatContainer.scrollTop = chatContainer.scrollHeight; }, 50); }
        function autoResizeInput() { userInput.style.height = 'auto'; userInput.style.height = userInput.scrollHeight + 'px'; }

        window.toggleChat = function() {
            if (chatWidget.style.display === 'none' || chatWidget.style.display === '') {
                chatWidget.style.display = 'flex';
                toggleBtn.style.display = 'none';
                micBtn.classList.add('mic-shifted');
                isChatOpen = true;
                if(isConversationMode) stopConversationMode();
                scrollToBottom();
            } else {
                chatWidget.style.display = 'none';
                toggleBtn.style.display = 'flex';
                micBtn.classList.remove('mic-shifted');
                isChatOpen = false;
            }
        }

        document.getElementById('chatForm').addEventListener('submit', (e) => {
            e.preventDefault();
            if(userInput.value.trim()) handleSendMessage(userInput.value.trim());
        });
        
        userInput.addEventListener('keydown', (e) => {
            if(e.key === 'Enter' && !e.shiftKey) { 
                e.preventDefault(); 
                if(userInput.value.trim()) handleSendMessage(userInput.value.trim()); 
            }
        });
    </script>
</body>
</html>